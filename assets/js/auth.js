// auth.js - نظام المستخدمين والحماية باستخدام localStorage\nimport { getUsers } from './api.js';\n\nexport function restoreThemePreference() {\n  // الوضع الليلي معطل\n}\n\nexport function initAuthGuards() {\n  document.querySelectorAll('[data-protected=\"true\"]').forEach(a => {\n    a.addEventListener('click', (e) => {\n      if (!isLoggedIn()) {\n        e.preventDefault();\n        window.location.href = 'login.html';\n      }\n    });\n  });\n}\n\nexport function isLoggedIn() {\n  return localStorage.getItem('itqan_isLoggedIn') === 'true';\n}\n\nexport function getCurrentUser() {\n  const raw = localStorage.getItem('itqan_currentUser');\n  return raw ? JSON.parse(raw) : null;\n}\n\nexport async function signup({ name, role, nationalId, phone, password, linkedStudents = [] }) {\n  if (!name || !role || !password) throw new Error('الرجاء إدخال جميع الحقول المطلوبة');\n  if (role === 'student' && !nationalId) throw new Error('الطالب يجب أن يُدخل الرقم القومي');\n  if (!phone) throw new Error('رقم الموبايل مطلوب للتحقق عبر الرسائل القصيرة');\n  await ensureUsersLoaded();\n  const users = JSON.parse(localStorage.getItem('itqan_users') || '[]');\n  const exists = users.find(u =>\n    u.role === role &&\n    ((role === 'student' && u.nationalId === nationalId) || (role !== 'student' && u.phone === phone))\n  );\n  if (exists) throw new Error('يوجد حساب بهذا المُعرّف بالفعل');\n  sendOtpDev(phone);\n  const input = prompt('أدخل كود التحقق المرسل عبر SMS');\n  if (!input || !verifyOtpDev(phone, input.trim())) {\n    throw new Error('فشل التحقف من كود OTP');\n  }\n  const user = {\n    id: 'u_' + Date.now(),\n    name,\n    role,\n    nationalId: role === 'student' ? nationalId : undefined,\n    phone,\n    passwordHash: simpleHash(password),\n    xp: 0,\n    badges: [],\n    enrolledCourses: [],\n    completedLessons: [],\n    linkedStudents: role === 'parent' ? linkedStudents : undefined,\n  };\n  users.push(user);\n  localStorage.setItem('itqan_users', JSON.stringify(users));\n  localStorage.setItem('itqan_currentUser', JSON.stringify(user));\n  localStorage.setItem('itqan_isLoggedIn', 'true');\n  return user;\n}\n\nexport function logout() {\n  localStorage.setItem('itqan_isLoggedIn', 'false');\n  localStorage.removeItem('itqan_currentUser');\n}\n\nexport function protectPage() {\n  if (!isLoggedIn()) {\n    window.location.href = 'login.html';\n  }\n}\n\nexport function completeLesson(lessonId) {\n  const user = getCurrentUser();\n  if (!user) return;\n  if (!user.completedLessons.includes(lessonId)) {\n    user.completedLessons.push(lessonId);\n    user.xp += 10;\n    checkAchievements(user);\n    persistUser(user);\n  }\n}\n\nexport function persistUser(updated) {\n  localStorage.setItem('itqan_currentUser', JSON.stringify(updated));\n  const users = JSON.parse(localStorage.getItem('itqan_users') || '[]');\n  const idx = users.findIndex(u => u.id === updated.id);\n  if (idx !== -1) {\n    users[idx] = updated;\n    localStorage.setItem('itqan_users', JSON.stringify(users));\n  }\n}\n\nexport function checkAchievements(user) {\n  const earned = new Set(user.badges || []);\n  const lessonsCount = (user.completedLessons || []).length;\n  if (lessonsCount >= 1 && !earned.has('first-lesson')) {\n    user.badges.push('first-lesson');\n  }\n  if (user.xp >= 100 && !earned.has('hundred-xp')) {\n    user.badges.push('hundred-xp');\n  }\n}\n\nfunction simpleHash(str) {\n  let h = 0;\n  for (let i = 0; i < str.length; i++) {\n    h = (h << 5) - h + str.charCodeAt(i);\n    h |= 0;\n  }\n  return 'h_' + Math.abs(h);\n}\n\nexport async function login({ role, nationalId, phone, password }) {\n  if (!role || !password) throw new Error('يرجى إدخال الدور وكلمة المرور');\n  await ensureUsersLoaded();\n  const users = JSON.parse(localStorage.getItem('itqan_users') || '[]');\n  const normalizedPhone = (phone || '').replace(/\\s+/g, '');\n  const normalizedNationalId = (nationalId || '').replace(/\\s+/g, '');\n  let user;\n  if (role === 'student') {\n    if (!normalizedNationalId) throw new Error('يرجى إدخال الرقم القومي للطالب');\n    user = users.find(u => u.role === 'student' && String(u.nationalId) === String(normalizedNationalId));\n  } else {\n    if (!normalizedPhone) throw new Error('يرجى إدخال رقم الموبايل');\n    user = users.find(u => u.role === role && String(u.phone) === String(normalizedPhone));\n  }\n  if (!user) throw new Error('لا يوجد مستخدم مطابق للمدخلات');\n  if (user.banned) throw new Error('الحساب محظور');\n  if (user.passwordHash !== simpleHash(password)) throw new Error('كلمة المرور غير صحيحة');\n  localStorage.setItem('itqan_currentUser', JSON.stringify(user));\n  localStorage.setItem('itqan_isLoggedIn', 'true');\n  return user;\n}\n\nexport async function ensureUsersLoaded() {\n  const existingRaw = localStorage.getItem('itqan_users');\n  let existing = [];\n  try { existing = existingRaw ? JSON.parse(existingRaw) : []; } catch { existing = []; }\n  try {\n    const remote = await getUsers();\n    const byId = new Map(existing.map(u => [u.id, u]));\n    for (const r of remote) {\n      const prev = byId.get(r.id);\n      if (prev) {\n        byId.set(r.id, {\n          ...prev,\n          ...r,\n          xp: prev.xp ?? r.xp ?? 0,\n          badges: prev.badges ?? r.badges ?? [],\n          enrolledCourses: prev.enrolledCourses ?? r.enrolledCourses ?? [],\n          completedLessons: prev.completedLessons ?? r.completedLessons ?? [],\n          linkedStudents: prev.linkedStudents ?? r.linkedStudents,\n          banned: prev.banned ?? r.banned ?? false\n        });\n      } else {\n        byId.set(r.id, r);\n      }\n    }\n    const merged = Array.from(byId.values());\n    localStorage.setItem('itqan_users', JSON.stringify(merged));\n  } catch (e) {\n    if (!existingRaw || existingRaw === '[]') {\n      localStorage.setItem('itqan_users', '[]');\n    }\n  }\n}\n\nexport function guardRole(requiredRole) {\n  const user = getCurrentUser();\n  if (!user) {\n    window.location.href = 'login.html';\n    return;\n  }\n  if (user.role !== requiredRole) {\n    window.location.href = 'index.html';\n    return;\n  }\n}\n\nexport function routeToDashboardByRole(userOrNull = null) {\n  const user = userOrNull || getCurrentUser();\n  if (!user) {\n    window.location.href = 'login.html';\n    return;\n  }\n  if (user.role === 'owner') {\n    window.location.href = 'dashboard.html';\n  } else {\n    window.location.href = 'index.html';\n  }\n}\n\nexport function sendOtpDev(phone) {\n  const code = String(Math.floor(100000 + Math.random() * 900000));\n  sessionStorage.setItem(`otp_${phone}`, code);\n  console.warn('OTP (DEV ONLY):', code);\n  return code;\n}\n\nexport function verifyOtpDev(phone, code) {\n  return sessionStorage.getItem(`otp_${phone}`) === code;\n}\n