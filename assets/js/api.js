// api.js - إدارة البيانات مع دمج ملف JSON وطبقة التعديلات المحلية\n\nexport async function getCourses() {\n  try {\n    const res = await fetch('./data/courses.json');\n    const remote = res.ok ? await res.json() : [];\n    const overlayRaw = localStorage.getItem('itqan_courses') || '[]';\n    let overlay = [];\n    try { overlay = JSON.parse(overlayRaw); } catch { overlay = []; }\n    const map = new Map(remote.map(c => [String(c.id), c]));\n    overlay.forEach(c => {\n      const id = String(c.id);\n      map.set(id, { ...(map.get(id) || {}), ...c });\n    });\n    return Array.from(map.values());\n  } catch {\n    const overlayRaw = localStorage.getItem('itqan_courses') || '[]';\n    try { return JSON.parse(overlayRaw); } catch { return []; }\n  }\n}\n\nexport async function getCourseById(id) {\n  const courses = await getCourses();\n  return courses.find(c => String(c.id) === String(id));\n}\n\nfunction saveCoursesOverlay(list) {\n  localStorage.setItem('itqan_courses', JSON.stringify(list));\n}\n\nexport function addCourse(course) {\n  const overlay = JSON.parse(localStorage.getItem('itqan_courses') || '[]');\n  const id = course.id || ('c_' + Date.now());\n  const newCourse = { ...course, id };\n  overlay.push(newCourse);\n  saveCoursesOverlay(overlay);\n  return newCourse;\n}\n\nexport function updateCourse(course) {\n  const overlay = JSON.parse(localStorage.getItem('itqan_courses') || '[]');\n  const idx = overlay.findIndex(c => String(c.id) === String(course.id));\n  if (idx !== -1) {\n    overlay[idx] = { ...overlay[idx], ...course };\n  } else {\n    overlay.push(course);\n  }\n  saveCoursesOverlay(overlay);\n  return overlay.find(c => String(c.id) === String(course.id));\n}\n\nexport function deleteCourse(id) {\n  const overlay = JSON.parse(localStorage.getItem('itqan_courses') || '[]');\n  const next = overlay.filter(c => String(c.id) !== String(id));\n  saveCoursesOverlay(next);\n  return true;\n}\n\nexport async function getUsers() {\n  try {\n    const res = await fetch('./data/users.json');\n    const remote = res.ok ? await res.json() : [];\n    const overlayRaw = localStorage.getItem('itqan_users') || '[]';\n    let overlay = [];\n    try { overlay = JSON.parse(overlayRaw); } catch { overlay = []; }\n    const byId = new Map(remote.map(u => [String(u.id), u]));\n    overlay.forEach(u => {\n      const id = String(u.id);\n      byId.set(id, { ...(byId.get(id) || {}), ...u });\n    });\n    return Array.from(byId.values());\n  } catch {\n    const overlayRaw = localStorage.getItem('itqan_users') || '[]';\n    try { return JSON.parse(overlayRaw); } catch { return []; }\n  }\n}\n\nexport function updateUserRole(userIdOrPhone, newRole) {\n  const users = JSON.parse(localStorage.getItem('itqan_users') || '[]');\n  const idx = users.findIndex(u => String(u.id) === String(userIdOrPhone) || String(u.phone) === String(userIdOrPhone));\n  if (idx === -1) return false;\n  users[idx].role = newRole;\n  localStorage.setItem('itqan_users', JSON.stringify(users));\n  return true;\n}\n\nexport function toggleUserBan(userIdOrPhone, banned = true) {\n  const users = JSON.parse(localStorage.getItem('itqan_users') || '[]');\n  const idx = users.findIndex(u => String(u.id) === String(userIdOrPhone) || String(u.phone) === String(userIdOrPhone));\n  if (idx === -1) return false;\n  users[idx].banned = banned;\n  localStorage.setItem('itqan_users', JSON.stringify(users));\n  return true;\n}\n